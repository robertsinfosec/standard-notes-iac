name: Deploy Standard Notes

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - production
        default: production
      first_deployment:
        description: 'First deployment (uses root user)'
        required: false
        type: boolean
        default: false

env:
  ANSIBLE_HOST_KEY_CHECKING: 'false'
  ANSIBLE_FORCE_COLOR: 'true'

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Ansible and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install Ansible collections
        run: |
          ansible-galaxy collection install -r src/requirements.yml

      - name: Create inventory file
        run: |
          cat > inventory.ini << EOF
          [standardnotes]
          ${{ secrets.SERVER_HOST }} ansible_port=${{ secrets.SERVER_PORT }}
          
          [standardnotes:vars]
          ansible_python_interpreter=/usr/bin/python3
          ansible_become=yes
          ansible_become_method=sudo
          EOF

      - name: Configure SSH (First Deployment)
        if: inputs.first_deployment == true
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Use root user and password for first deployment
          cat >> inventory.ini << EOF
          ansible_user=root
          ansible_password=${{ secrets.ROOT_PASSWORD }}
          EOF

      - name: Configure SSH (Subsequent Deployments)
        if: inputs.first_deployment == false
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Use service-deployer user with SSH key
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          cat >> inventory.ini << EOF
          ansible_user=service-deployer
          ansible_ssh_private_key_file=~/.ssh/id_ed25519
          EOF

      - name: Create .env file
        run: |
          cat > src/.env << EOF
          DOMAIN=${{ secrets.DOMAIN }}
          API_DOMAIN=${{ secrets.API_DOMAIN }}
          LETSENCRYPT_EMAIL=${{ secrets.LETSENCRYPT_EMAIL }}
          CF_API_EMAIL=${{ secrets.CF_API_EMAIL }}
          CF_API_TOKEN=${{ secrets.CF_API_TOKEN }}
          MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
          MYSQL_USER=${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          AUTH_JWT_SECRET=${{ secrets.AUTH_JWT_SECRET }}
          ENCRYPTION_SERVER_KEY=${{ secrets.ENCRYPTION_SERVER_KEY }}
          VALET_TOKEN_SECRET=${{ secrets.VALET_TOKEN_SECRET }}
          SMTP_HOST=${{ secrets.SMTP_HOST }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}
          SMTP_USERNAME=${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}
          SMTP_FROM_ADDRESS=${{ secrets.SMTP_FROM_ADDRESS }}
          TIMEZONE=${{ secrets.TIMEZONE }}
          EOF

      - name: Run Ansible playbook
        run: |
          cd src
          ansible-playbook \
            -i ../inventory.ini \
            site.yml \
            -v

      - name: Verify deployment
        run: |
          echo "Waiting for service to be healthy..."
          sleep 30
          
          # Check if HTTPS endpoint is responding
          curl -f -I https://${{ secrets.DOMAIN }} || exit 1
          
          echo "Deployment verification successful"

      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f ~/.ssh/id_ed25519
          rm -f src/.env
          rm -f inventory.ini
